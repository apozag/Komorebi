<RenderInfo>
	<m_renderPipelines>
		<RenderPipeline>
			<m_name>DEFERRED_MAIN</m_name>
			<m_steps>
				<!-- Clear rendertargets -->
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>DEFAULT</m_outRtId>
				</RenderStep>
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>GBUFFER</m_outRtId>
				</RenderStep>
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>HDR</m_outRtId>
				</RenderStep>
				<!-- Render opaque geometry to GBuffer -->
				<RenderStep Type="GeometryRenderStepType">
					<m_outRtId>GBUFFER</m_outRtId>
					<m_maxLayer>99</m_maxLayer>
				</RenderStep>
				<!-- Render skybox to separate rt -->
				<RenderStep Type="CubeRenderStepType">
					<m_resourceInputs>
						<resourceId>ENVMAP</resourceId>
					</m_resourceInputs>					
					<m_outRtId>GBUFFER</m_outRtId>
					<m_material>assets/materials/hdrEnvMapMat.xml</m_material>
				</RenderStep>			
				<!-- Ambient IBL -->	
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>1</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
						<!-- <TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
						</TextureInfoType> -->
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>4</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_resourceInputs>
						<resourceId>ENVMAP</resourceId>
						<resourceId>BRDF</resourceId>
					</m_resourceInputs>>
					<m_outRtId>HDR</m_outRtId>
					<m_material>assets/materials/composeAmbientMat.xml</m_material>
				</RenderStep>
				<!-- Directional lights -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>1</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>4</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>					
					<m_outRtId>HDR</m_outRtId>
					<m_repeatFor>DIRLIGHT</m_repeatFor>
					<m_material>assets/materials/composeDirlightMat.xml</m_material>
				</RenderStep>
				<!-- Copy skybox to HDR -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
							<m_slot>0</m_slot>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>HDR</m_outRtId>
					<m_material>assets/materials/blitMat.xml</m_material>
				</RenderStep>
				<!-- Render transparent geometry -->
				<RenderStepType Type="GeometryRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>HDR</m_outRtId>
					<m_outDSId>GBUFFER</m_outDSId>
					<m_maxLayer>199</m_maxLayer>
					<m_sortReverse>true</m_sortReverse>
				</RenderStep>
				<!-- Render portals -->
				<RenderStepType Type="GeometryRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>PORTAL</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>HDR</m_outRtId>
					<m_outDSId>GBUFFER</m_outDSId>
					<m_maxLayer>301</m_maxLayer>
				</RenderStep>
				<!-- Copy HDR to bloom texture -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>HDR</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>BLOOM</m_outRtId>
					<m_material>assets/materials/filterBrightBlitMat.xml</m_material>
				</RenderStep>
				<!-- Blur bloom texture -->
				<RenderStep Type="DownsampleRenderStepType">					
					<m_outRtId>BLOOM</m_outRtId>
					<m_iterations>5</m_iterations>
				</RenderStep>
				<!-- Add blurred bloom to HDR -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>BLOOM</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>HDR</m_outRtId>
					<m_material>assets/materials/blitAddMat.xml</m_material>
				</RenderStep>
				<!-- Tonemapping -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>HDR</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>DEFAULT</m_outRtId>
					<m_repeatFor>ONCE</m_repeatFor>
					<m_material>assets/materials/tonemappingMat.xml</m_material>
				</RenderStep>
			</m_steps>
		</RenderPipeline>	
		<RenderPipeline>
			<m_name>DEFERRED_PORTAL</m_name>
			<m_steps>
				<!-- Clear rendertargets -->
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>DEFAULT</m_outRtId>
				</RenderStep>
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>GBUFFER</m_outRtId>
				</RenderStep>
				<RenderStep Type="ClearRenderStepType">
					<m_outRtId>PORTAL</m_outRtId>
				</RenderStep>
				<!-- Render opaque geometry to GBuffer -->
				<RenderStep Type="GeometryRenderStepType">
					<m_outRtId>GBUFFER</m_outRtId>
					<m_maxLayer>99</m_maxLayer>
				</RenderStep>
				<!-- Render skybox to separate rt -->
				<RenderStep Type="CubeRenderStepType">
					<m_resourceInputs>
						<resourceId>ENVMAP</resourceId>
					</m_resourceInputs>					
					<m_outRtId>GBUFFER</m_outRtId>
					<m_material>assets/materials/hdrEnvMapMat.xml</m_material>
				</RenderStep>			
				<!-- Ambient IBL -->	
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>1</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
						<!-- <TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
						</TextureInfoType> -->
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>4</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_resourceInputs>
						<resourceId>ENVMAP</resourceId>
						<resourceId>BRDF</resourceId>
					</m_resourceInputs>>
					<m_outRtId>PORTAL</m_outRtId>
					<m_material>assets/materials/composeAmbientMat.xml</m_material>
				</RenderStep>
				<!-- Directional lights -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>0</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>1</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
						</TextureInfoType>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>4</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>					
					<m_outRtId>PORTAL</m_outRtId>
					<m_repeatFor>DIRLIGHT</m_repeatFor>
					<m_material>assets/materials/composeDirlightMat.xml</m_material>
				</RenderStep>
				<!-- Copy skybox to HDR -->
				<RenderStep Type="ScreenRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>3</m_textureIdx>
							<m_slot>0</m_slot>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>PORTAL</m_outRtId>
					<m_material>assets/materials/blitMat.xml</m_material>
				</RenderStep>
				<!-- Render transparent geometry -->
				<RenderStepType Type="GeometryRenderStepType">
					<m_textureInputs>
						<TextureInfoType>
							<m_rtId>GBUFFER</m_rtId>
							<m_textureIdx>2</m_textureIdx>
						</TextureInfoType>
					</m_textureInputs>
					<m_outRtId>PORTAL</m_outRtId>
					<m_outDSId>GBUFFER</m_outDSId>
					<m_maxLayer>199</m_maxLayer>
					<m_sortReverse>true</m_sortReverse>								
				</RenderStep>
			</m_steps>
		</RenderPipeline>
	</m_renderPipelines>
	<m_globalRTs>
		<RTNamePairType>
			<m_name>HDR</m_name>
			<m_rt>
				<m_count>1</m_count>
				<m_width>-1</m_width>
				<m_height>-1</m_height>
				<m_format>DXGI_FORMAT_R32G32B32A32_FLOAT</m_format>
				<m_slot>0</m_slot>
				<m_mipLevels>1</m_mipLevels>
				<m_hasDS>false</m_hasDS>
			</m_rt>
		</RTNamePairType>
		<RTNamePairType>
			<m_name>GBUFFER</m_name>
			<m_rt>
				<m_count>5</m_count>
				<m_width>-1</m_width>
				<m_height>-1</m_height>
				<m_format>DXGI_FORMAT_R32G32B32A32_FLOAT</m_format>
				<m_slot>7</m_slot>
				<m_mipLevels>1</m_mipLevels>
				<m_hasDS>true</m_hasDS>
			</m_rt>
		</RTNamePairType>
		<RTNamePairType>
			<m_name>BLOOM</m_name>
			<m_rt>
				<m_count>1</m_count>
				<m_width>-1</m_width>
				<m_height>-1</m_height>
				<m_format>DXGI_FORMAT_R32G32B32A32_FLOAT</m_format>
				<m_slot>0</m_slot>
				<m_mipLevels>1</m_mipLevels>
				<m_hasDS>false</m_hasDS>
				<m_allowUAV>true</m_allowUAV>
			</m_rt>
		</RTNamePairType>
		<RTNamePairType>
			<m_name>PORTAL</m_name>
			<m_rt>
				<m_count>1</m_count>
				<m_width>-1</m_width>
				<m_height>-1</m_height>
				<m_format>DXGI_FORMAT_R32G32B32A32_FLOAT</m_format>
				<m_slot>0</m_slot>
				<m_mipLevels>1</m_mipLevels>
				<m_hasDS>false</m_hasDS>
			</m_rt>
		</RTNamePairType>
	</m_globalRTs>
	<m_globalResources>
		<RTNamePairType>
			<m_name>ENVMAP</m_name>
			<m_resource Type="RadianceMap">
				<m_filename>assets\images\hdri\pine_attic_4k.png</m_filename>
				<m_slot>12</m_slot>
				<m_size>258</m_size>
				<m_mipLevels>5</m_mipLevels>
			</m_resource>
		</RTNamePairType>
		<RTNamePairType>
			<m_name>BRDF</m_name>
			<m_resource Type="Texture2D">
				<m_filename>assets\images\lut\ibl_brdf_lut.png</m_filename>
				<m_slot>14</m_slot>
			</m_resource>
		</RTNamePairType>
	</m_globalResources>
</RenderInfo>
